name: Daily Horoscopes Commit

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repo
        uses: actions/checkout@v4

      - name: Generate and update hexagram
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          # ç”Ÿæˆå¦è±¡å†…å®¹ï¼ˆåŒå‰ï¼‰
          HEXAGRAMS=$(cat data/yijing_64gua.json)
          SEED=$(date '+%Y%m%d')
          INDEX=$(( SEED % 64 ))
          HEXAGRAM=$(echo "$HEXAGRAMS" | jq ".[$INDEX]")
          # ...æå–å˜é‡è¿‡ç¨‹åŒå‰...

          # ç”Ÿæˆä¸´æ—¶æ–‡ä»¶ï¼ˆç¡®ä¿æœ«å°¾æœ‰æ¢è¡Œï¼‰
          {
            echo "# $SYMBOL $NAME"
            echo ""
            echo "**å¦è¾**"
            echo "$TEXT"
            echo ""
            echo "**å¤§è±¡**"
            echo "$IMAGE"
            echo ""
            echo "**å¯ç¤º**"
            echo "$INTERPRETATION"
            echo ""  # æ·»åŠ ç©ºè¡Œç¡®ä¿æ ¼å¼
          } > temp_divination.md

          # åˆ†ä¸¤æ­¥å¤„ç†ï¼š
          # 1. æ¸…ç©ºæ ‡è®°é—´å†…å®¹ï¼ˆä¿ç•™æ ‡è®°ï¼‰
          sed -i '/<!-- YIJING-START -->/,/<!-- YIJING-END -->/ {
              /<!-- YIJING-START -->/! {
                  /<!-- YIJING-END -->/!d
              }
          }' README.md

          # 2. åœ¨å¼€å§‹æ ‡è®°åæ’å…¥æ–°å†…å®¹
          sed -i '/<!-- YIJING-START -->/ r temp_divination.md' README.md

          # è°ƒè¯•è¾“å‡º
          echo "æœ€ç»ˆå†…å®¹ç»“æ„ï¼š"
          sed -n '/<!-- YIJING-START -->/,/<!-- YIJING-END -->/p' README.md

      - name: Commit changes
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "CYXNBNBNB"
          git config --global user.email "cyxnbnbnb@gmail.com"
          git add README.md
          git commit -m "ğŸŒŒ Mystic update $(date '+%Y-%m-%d')" || echo "No changes"
          git push origin main