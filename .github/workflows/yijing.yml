name: ğŸŒŒ Mystic I Ching Daily

on:
  schedule:
    - cron: '0 0 * * *'   # æ¯å¤© UTC 00:00ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  workflow_dispatch:

jobs:
  iching-commit:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ´ Generate I Ching Divination
        id: divination
        run: |
          # å®‰è£…JSONå¤„ç†å·¥å…·
          sudo apt-get -qq install jq

          # åŠ è½½64å¦æ•°æ®
          ICHING_JSON_PATH="data/yijing_64gua.json"   # å‡è®¾æ–‡ä»¶åœ¨ä»“åº“çš„ data æ–‡ä»¶å¤¹ä¸­
          if [ ! -f "$ICHING_JSON_PATH" ]; then
            echo "æ˜“ç»æ•°æ®æ–‡ä»¶æœªæ‰¾åˆ°ï¼"
            exit 1
          fi

          # éšæœºé€‰æ‹©å¦è±¡ (0-63)
          HEXAGRAM_INDEX=$(( RANDOM % 64 ))
          
          # ä½¿ç”¨jqè§£æJSONæ–‡ä»¶
          HEXAGRAM=$(jq -r ".[$HEXAGRAM_INDEX]" "$ICHING_JSON_PATH")
          
          # æå–å¦è±¡ä¿¡æ¯
          SYMBOL=$(echo $HEXAGRAM | jq -r '.symbol')
          NAME=$(echo $HEXAGRAM | jq -r '.name')
          TEXT=$(echo $HEXAGRAM | jq -r '.text')
          IMAGE=$(echo $HEXAGRAM | jq -r '.image')
          INTERPRETATION=$(echo $HEXAGRAM | jq -r '.interpretation')

          # æ ¼å¼åŒ–è¾“å‡º
          echo "SYMBOL=$SYMBOL" >> $GITHUB_OUTPUT
          echo "NAME=$NAME" >> $GITHUB_OUTPUT
          echo "TEXT=$TEXT" >> $GITHUB_OUTPUT
          echo "IMAGE=$IMAGE" >> $GITHUB_OUTPUT
          echo "INTERPRETATION=$INTERPRETATION" >> $GITHUB_OUTPUT

      - name: ğŸ“– Update README
        run: |
          DATE=$(date '+%Y-%m-%d')
          DIVINATION_BANNER=$(cat <<EOF

          ## ğŸŒ™ ä»Šæ—¥å¦è±¡ ($DATE)

          ### ${{ steps.divination.outputs.SYMBOL }} ${{ steps.divination.outputs.NAME }}
          **å¦è¾**: ${{ steps.divination.outputs.TEXT }}  
          **å¤§è±¡**: ${{ steps.divination.outputs.IMAGE }}  
          **å¯ç¤º**: ${{ steps.divination.outputs.INTERPRETATION }}

          EOF
          )

          echo "$DIVINATION_BANNER" >> README.md
          echo "âœ… å·²æ›´æ–°ä»Šæ—¥å¦è±¡"

      - name: ğŸš€ Commit Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "æ˜“ç»å åœå®˜"
          git config --global user.email "cyxnbnbnb@gmail.com"
          git remote set-url origin https://x-access-token:$GITHUB_TOKEN@github.com/${{ github.repository }}
          git add README.md
          git commit -m "ğŸŒŒ ${{ steps.divination.outputs.SYMBOL }} å¦è±¡æ›´æ–° - $(date '+%Y-%m-%d')" || echo "ğŸ”„ æ— å†…å®¹å˜æ›´"
          git push origin main
