name: Daily Horoscopes Commit

on:
  schedule:
    - cron: '0 0 * * *'   # 每天 UTC 00:00（北京时间 08:00）
  workflow_dispatch:

jobs:
  commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repo
        uses: actions/checkout@v4

      - name: Generate daily I Ching hexagram and update README
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          # 加载64卦数据
          HEXAGRAMS=$(cat data/yijing_64gua.json)

          # 生成每日唯一索引
          SEED=$(date '+%Y%m%d')
          INDEX=$(( SEED % 64 ))

          # 提取卦象信息
          HEXAGRAM=$(echo "$HEXAGRAMS" | jq ".[$INDEX]")
          SYMBOL=$(echo "$HEXAGRAM" | jq -r '.symbol')
          NAME=$(echo "$HEXAGRAM" | jq -r '.name')
          TEXT=$(echo "$HEXAGRAM" | jq -r '.text')
          IMAGE=$(echo "$HEXAGRAM" | jq -r '.image')
          INTERPRETATION=$(echo "$HEXAGRAM" | jq -r '.interpretation')

          # 生成临时文件（不含标记）
          {
            echo "# $SYMBOL $NAME"
            echo ""
            echo "**卦辞**"
            echo "$TEXT"
            echo ""
            echo "**大象**"
            echo "$IMAGE"
            echo ""
            echo "**启示**"
            echo "$INTERPRETATION"
          } > temp_divination.md

          # 精准替换内容（保留标记）
          sed -i '/<!-- YIJING-START -->/,/<!-- YIJING-END -->/ {
              /<!-- YIJING-START -->/! {
                  /<!-- YIJING-END -->/!d
              }
              /<!-- YIJING-START -->/ {
                  n
                  r temp_divination.md
                  :loop
                  N
                  /<!-- YIJING-END -->/!b loop
              }
          }' README.md

          # 强制校验标记完整性
          if ! grep -q '<!-- YIJING-START -->' README.md; then
              echo "ERROR: Start marker missing!" >&2
              exit 1
          fi
          if ! grep -q '<!-- YIJING-END -->' README.md; then
              echo "ERROR: End marker missing! Recovering..."
              echo "<!-- YIJING-END -->" >> README.md
          fi

          # 调试输出
          echo "Final content between markers:"
          sed -n '/<!-- YIJING-START -->/,/<!-- YIJING-END -->/p' README.md

      - name: Commit and push changes
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "CYXNBNBNB"
          git config --global user.email "cyxnbnbnb@gmail.com"

          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}

          git add README.md
          git commit -m "🌌 Mystic update on $(date '+%Y-%m-%d')" || echo "No changes to commit"
          git push origin main