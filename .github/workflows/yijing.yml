name: Daily Horoscopes Commit

on:
  schedule:
    - cron: '0 0 * * *'   # æ¯å¤© UTC 00:00ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  workflow_dispatch:

jobs:
  commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repo
        uses: actions/checkout@v4

      - name: Generate daily I Ching hexagram and update README
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          # åŠ è½½64å¦æ•°æ®
          HEXAGRAMS=$(cat data/yijing_64gua.json)

          # ç”¨æ—¥æœŸä½œä¸ºç§å­ç¡®ä¿æ¯å¤©å”¯ä¸€ä¸”ä¸å˜
          DATE=$(date '+%Y-%m-%d')
          SEED=$(date '+%Y%m%d')
          INDEX=$(( SEED % 64 ))

          HEXAGRAM=$(echo "$HEXAGRAMS" | jq ".[$INDEX]")

          SYMBOL=$(echo "$HEXAGRAM" | jq -r '.symbol')
          NAME=$(echo "$HEXAGRAM" | jq -r '.name')
          TEXT=$(echo "$HEXAGRAM" | jq -r '.text')
          IMAGE=$(echo "$HEXAGRAM" | jq -r '.image')
          INTERPRETATION=$(echo "$HEXAGRAM" | jq -r '.interpretation')

          # è¾“å‡ºç”Ÿæˆçš„å åœå†…å®¹ç”¨äºè°ƒè¯•
          echo "<!-- YIJING-START -->"
          echo "# $SYMBOL $NAME"
          echo ""
          echo "**å¦è¾**"
          echo "$TEXT"
          echo ""
          echo "**å¤§è±¡**"
          echo "$IMAGE"
          echo ""
          echo "**å¯ç¤º**"
          echo "$INTERPRETATION"
          echo "<!-- YIJING-END -->"
          
          # å°†å åœå†…å®¹å†™å…¥ temp_divination.md
          {
            echo "<!-- YIJING-START -->"
            echo "# $SYMBOL $NAME"
            echo ""
            echo "**å¦è¾**"
            echo "$TEXT"
            echo ""
            echo "**å¤§è±¡**"
            echo "$IMAGE"
            echo ""
            echo "**å¯ç¤º**"
            echo "$INTERPRETATION"
            echo "<!-- YIJING-END -->"
          } > temp_divination.md

          # æ¸…ç†æ‰ README.md ä¸­çš„æ—§å åœå†…å®¹
          sed -i '/<!-- YIJING-START -->/ { :a; /<!-- YIJING-END -->/ { n; b }; n; ba }' README.md

          # è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼Œç¡®ä¿ sed åˆ é™¤æ“ä½œæ­£ç¡®
          echo "After sed deletion, README.md looks like this:"
          cat README.md

          # æ›¿æ¢ README ä¸­çš„åŒºå—
          awk '
            BEGIN {found=0}
            /<!-- YIJING-START -->/ {
              if (!found) { 
                print;
                while ((getline line < "temp_divination.md") > 0) print line; 
                found=1;
              }
              next
            }
            /<!-- YIJING-END -->/ {found=0; next}
            {print}
          ' README.md > README_tmp.md && mv README_tmp.md README.md

          # è¾“å‡ºæ›¿æ¢åçš„ README å†…å®¹ä»¥ä¾¿éªŒè¯
          echo "After awk replacement, README.md looks like this:"
          cat README.md

      - name: Commit and push changes
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "CYXNBNBNB"
          git config --global user.email "cyxnbnbnb@gmail.com"

          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}

          git add README.md
          git commit -m "ğŸŒŒ Mystic update on $(date '+%Y-%m-%d')" || echo "No changes to commit"
          git push origin main
